# Auto Refiner

SillyTavern 自动精修插件

由于 GPT/Claude 等模型总是情不自禁地疯狂吐字，动不动就写几千token的小作文，并且在其中夹杂令人费解的奇妙小巧思（比如突然让角色说出不符合人设的话、逻辑前后矛盾、或者干脆开始自说自话），作此小工具用于自动化 AI 二次生成指令。

## 工作原理

插件监听酒馆的 generation_ended 事件。当 AI 输出完成后，插件会检测当前聊天状态，自动在输入框填入预设的精修指令并发送。等 AI 输出修正版后，插件会把修正版内容复制到原消息里，然后删除中间产生的指令消息和修正消息，最后保存并刷新聊天记录。整个过程对用户透明，聊天记录里只会保留最终的精修版本。

## 技术架构

本插件基于 SillyTavern 的 ES Module 扩展规范开发。

核心依赖从酒馆主脚本导入：
- eventSource：事件总线，用于监听生成开始、结束、停止等事件
- saveChat：保存当前聊天记录到文件
- reloadCurrentChat：重新加载并渲染聊天记录
- getContext：获取酒馆上下文，包括当前聊天数组和扩展设置

插件使用动态导入兼容两种安装路径。通过 GitHub 安装会放到 extensions/third-party/ 目录，手动安装会放到 extensions/ 目录，两种情况的相对路径不同。插件启动时会先尝试 third-party 路径，失败后回退到直接路径。

## 状态管理

插件使用三个核心状态变量：

globalTxId（事务ID）：一个自增的数字，每当发生可能破坏上下文的操作（换角色卡、切换聊天记录、用户点击停止）时自增。所有异步操作（setTimeout）在执行前都会检查当前 TxId 是否和启动时一致，不一致则直接终止。这个机制确保旧的异步任务不会干扰新的聊天环境。

lastStopTimestamp（停止时间戳）：记录用户最后一次点击停止按钮的时间。插件在触发任何操作前都会检查距离上次停止是否超过2秒。这个机制防止用户手动中断生成后插件误触发。

isCurrentlyProcessing（处理锁）：标记当前是否正在执行精修流程。防止 generation_ended 事件重复触发导致发送多条精修指令。

## 流程详解

Phase 1 初稿检测：

当 generation_ended 触发时，插件等待800毫秒让酒馆完成 DOM 渲染和数据同步。然后检查聊天数组最后两条消息。如果最后一条是 AI 消息，倒数第二条是普通用户消息（不包含精修标记），则判定为初稿完成，进入精修流程。

插件会检查初稿长度是否达到最低字数要求（默认15字）。如果太短说明可能是破限失败或网络问题，跳过精修避免浪费 token。

检查通过后，插件在输入框填入精修指令（带有隐藏标记），触发 input 和 change 事件通知酒馆的数据绑定，然后模拟点击发送按钮。

Phase 2 修正稿检测与合并：

第二次 generation_ended 触发时，插件再次检查聊天数组。如果倒数第二条是用户消息且包含精修标记，则判定为修正稿完成，进入合并流程。

插件会锁定最后三条消息的对象引用（不是内容，是内存地址）。这是核心安全机制。然后等待1秒，再次检查这三个对象是否还在原来的位置。如果期间用户删除了消息、切换了聊天、或者其他插件修改了数组，对象引用会不一致，插件会立即终止合并防止数据错乱。

校验通过后，插件把修正稿的 mes 字段复制到原稿对象里，然后用 splice 删除数组最后两条（精修指令和修正稿）。最后调用 saveChat 保存到文件，调用 reloadCurrentChat 刷新界面。

## 精修标记

插件使用 \u200B<!--AR-->\u200B 作为隐藏标记。\u200B 是零宽空格，肉眼不可见。<!--AR--> 是 HTML 注释，渲染时不显示。这个组合几乎不可能被普通正则表达式匹配到，也不会影响消息的显示效果。

插件通过检测消息内容是否包含 <!--AR--> 来判断这条消息是否是自己发送的精修指令。这是无状态设计的核心，即使插件崩溃重启，只要聊天记录还在，插件就能正确识别当前处于哪个阶段。

## 事件监听

generation_ended：生成结束，触发主流程
generation_started：生成开始，重置处理锁防止卡死
generation_stopped：用户点击停止，更新时间戳并销毁当前事务
chat_id_changed：切换聊天记录，销毁当前事务
character_loaded：加载角色卡，销毁当前事务

## 设置持久化

插件设置存储在 context.extensionSettings.auto_refiner 对象里。修改设置后调用 context.saveSettingsDebounced() 保存。这是酒馆官方推荐的扩展设置保存方式，设置会随酒馆的 settings.json 一起持久化。

## 界面集成

插件在 #extensions_settings 容器里追加一个 inline-drawer 面板，包含启用开关、临时开关选项、最低字数输入框、精修提示词文本框。样式遵循酒馆的 UI 规范，兼容各种主题。

临时开关按钮插入到 #send_but 发送按钮之前。使用 Font Awesome 的 fa-wand-magic-sparkles 图标。激活状态添加 active 类，通过 CSS 改变颜色和透明度。按钮状态不持久化，刷新页面后恢复为激活状态。

## 兼容性

正则表达式：插件操作的是 chat 数组里已经经过正则处理的消息内容，不会绕过或干扰酒馆的正则功能。如果你的正则会删除 HTML 注释，需要添加排除规则保留 <!--AR--> 标记。

前端渲染：插件操作的是原始 mes 字符串，渲染是酒馆在读取 mes 后进行的。reloadCurrentChat 会触发重新渲染。

其他插件：如果有插件也监听 generation_ended 并修改 chat 数组，可能产生冲突。插件的对象引用校验可以检测到这种情况并终止操作。

## 文件结构

index.js：主逻辑文件，包含所有功能代码
manifest.json：插件元数据，声明入口文件和版本信息

## 安装

酒馆内安装：设置 - 扩展 - Install Extension - 输入仓库地址

手动安装：进入 SillyTavern/data/default-user/extensions 目录执行 git clone

安装后刷新页面，在扩展设置里找到 Auto Refiner 启用即可。

## 配置项

启用插件：总开关，关闭后插件完全不工作

显示临时开关：开启后在发送按钮旁边显示魔法棒图标，点击可临时暂停精修

最低字数：AI 回复少于此字数不触发精修，用于过滤破限失败和空回复

精修提示词：发送给 AI 的具体指令内容，可根据需求自定义

## 注意事项

每次对话消耗双倍 token

精修过程中手动停止会在聊天记录里残留未完成的消息

建议配合合适的系统提示词使用

## 仓库地址

https://github.com/ourgods/SillyTavern-AutoRefiner
